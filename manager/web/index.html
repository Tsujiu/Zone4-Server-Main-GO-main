<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Zone4 Channel Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=Bangers&family=Russo+One&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; background: #181c23; color: #fafafa;}
    h2 { font-family:'Orbitron',Arial,sans-serif; font-size:2.1em; letter-spacing:2px; color:#facc15; margin-bottom:16px; text-shadow:1px 2px 2px #000,0 0 5px #111;}
    .channel { margin-bottom:10px; }
    .active { color:#22c55e; font-weight:bold; }
    .inactive { color:#ef4444; font-weight:bold; }
    button { margin-left:10px; padding:2px 12px; border-radius:7px; border:none; cursor:pointer; }
    .on { background:#22c55e; color:#fff; }
    .off { background:#ef4444; color:#fff; }
    .restart { background:#2563eb; color:#fff; }
    #all-btns { margin-top:18px; }
    #summary { margin-bottom:18px; font-size:1.08em; }
    #logs { background:#23272e; color:#facc15; padding:10px 12px; border-radius:8px; margin-top:16px; max-width:600px; min-height:40px; }
    .canlog { background:#21262b; color:#6ee7b7; margin-top:7px; padding:7px; border-radius:7px; font-size:0.98em; max-height: 160px; overflow-y:auto;}
    @media (max-width:600px){ body{padding:10px; font-size:1.01em} #logs{max-width:100%} }
    #main { display:none; }
    #login { display:flex; flex-direction:column; gap:10px; max-width:250px; margin:40px auto; text-align:center;}
    #login input { padding:7px; border-radius:8px; }
    #login button { padding:8px 15px; border:none; border-radius:6px; background:#2563eb; color:#fff; font-weight:600;}
    #loginMsg { color:#ef4444; }
    .emc2 { font-family:'Bangers','Orbitron','Russo One',Arial,sans-serif; font-size:2em; letter-spacing:1px; color:#38bdf8; margin-left:12px; text-shadow:1px 2px 2px #000; vertical-align:middle;}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login">
    <h2>Login</h2>
    <input type="password" id="senha" placeholder="Password" />
    <button onclick="doLogin()">Login</button>
    <span id="loginMsg"></span>
  </div>

  <!-- PAINEL PRINCIPAL -->
  <div id="main">
    <h2>Zone4 Channel Manager <span class="emc2">E=mc²</span></h2>
    <div id="summary"></div>
    <div id="channels"></div>
    <div id="all-btns">
      <button onclick="startAll()" class="on">Start All</button>
      <button onclick="stopAll()" class="off">Stop All</button>
      <span id="msg"></span>
    </div>
    <div id="logs"></div>
  </div>

<script>
  // ========= LOGIN =========
  const password = "zone4admin";
  function doLogin() {
    const s = document.getElementById("senha").value;
    if (s === password) {
      document.getElementById("login").style.display = "none";
      document.getElementById("main").style.display = "block";
      fetchStatus();
      setInterval(fetchStatus, 5000);
    } else {
      document.getElementById("loginMsg").textContent = "Wrong password!";
    }
  }

  // ========= LOG VISUAL =========
  function logCmd(msg) {
    const logs = document.getElementById("logs");
    const now = new Date().toLocaleTimeString();
    logs.innerHTML = `<div>[${now}] ${msg}</div>` + logs.innerHTML;
  }
  function msg(t) {
    document.getElementById("msg").textContent = t;
    setTimeout(() => (document.getElementById("msg").textContent = ""), 1500);
  }

  // ========= API =========
  const apiBase = window.location.origin;

  async function fetchJSON(url, opts = {}) {
    try {
      const r = await fetch(url, opts);
      if (!r.ok) throw new Error(r.statusText);
      const ct = r.headers.get("content-type") || "";
      return ct.includes("application/json") ? r.json() : r.text();
    } catch (e) {
      // fallback para GET quando POST não estiver implementado no backend
      if (opts.method === "POST") return fetchJSON(url, { method: "GET" });
      throw e;
    }
  }

  async function fetchStatus() {
    const data = await fetchJSON(`${apiBase}/status`);
    renderChannels(data);
    renderSummary(data);
  }

  function renderSummary(channels) {
    const running = channels.filter(c => c.running).length;
    document.getElementById("summary").innerHTML =
      `<b>Status geral:</b> ${running} de ${channels.length} canais ativos`;
  }

  function renderChannels(channels) {
    const div = document.getElementById("channels");
    div.innerHTML = "";
    channels.forEach(ch => {
      div.innerHTML += `
        <div class="channel">
          <b>${ch.name}</b>:
          <span class="${ch.running ? "active" : "inactive"}">
            ${ch.running ? "Active" : "Inactive"}
          </span>
          <button class="on" onclick="startChannel('${ch.id}')">Start</button>
          <button class="off" onclick="stopChannel('${ch.id}')">Stop</button>
          <button class="restart" onclick="restartChannel('${ch.id}')">Restart</button>
          <span style="margin-left:10px; color:#94a3b8; font-size:0.92em">Port: ${ch.port}</span>
          <button style="margin-left:8px;background:#facc15;color:#222" onclick="showLog('${ch.id}')">Show Log</button>
          <div id="canlog_${ch.id}" class="canlog" style="display:none"></div>
        </div>
      `;
    });
  }

  async function startChannel(id) {
    await fetchJSON(`${apiBase}/start/${id}`, { method: "POST" });
    fetchStatus();
    logCmd("Started " + id);
  }
  async function stopChannel(id) {
    await fetchJSON(`${apiBase}/stop/${id}`, { method: "POST" });
    fetchStatus();
    logCmd("Stopped " + id);
  }
  async function restartChannel(id) {
    await fetchJSON(`${apiBase}/stop/${id}`, { method: "POST" });
    setTimeout(async () => {
      await fetchJSON(`${apiBase}/start/${id}`, { method: "POST" });
      fetchStatus();
      logCmd("Restarted " + id);
    }, 500);
  }
  async function startAll() {
    await fetchJSON(`${apiBase}/start-all`, { method: "POST" });
    fetchStatus();
    logCmd("Started all channels");
    msg("All channels started!");
  }
  async function stopAll() {
    await fetchJSON(`${apiBase}/stop-all`, { method: "POST" });
    fetchStatus();
    logCmd("Stopped all channels");
    msg("All channels stopped!");
  }

  // LOGS DE CADA CANAL
  async function showLog(id) {
    const el = document.getElementById("canlog_" + id);
    if (el.style.display === "none") {
      el.style.display = "block";
      await fetchChannelLog(id);
    } else {
      el.style.display = "none";
    }
  }
  async function fetchChannelLog(id) {
    try {
      const res = await fetch(`${apiBase}/logs/${id}.log`);
      if (res.ok) {
        const txt = await res.text();
        document.getElementById("canlog_" + id).textContent = txt;
      } else {
        document.getElementById("canlog_" + id).textContent = "No log available.";
      }
    } catch {
      document.getElementById("canlog_" + id).textContent = "Error loading log.";
    }
  }
</script>
</body>
</html>
